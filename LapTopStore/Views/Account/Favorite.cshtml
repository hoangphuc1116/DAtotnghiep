@model IEnumerable<LapTopStore.Models.ViewModels.FavoriteVM>
@using System.Globalization
@{
    ViewData["Title"] = "Yêu thích";
}
<!-- ...:::: Start Breadcrumb Section:::... -->
<div class="breadcrumb-section breadcrumb-bg-color--golden">
    <div class="breadcrumb-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h3 class="breadcrumb-title">Yêu Thích</h3>
                    <div class="breadcrumb-nav breadcrumb-nav-color--black breadcrumb-nav-hover-color--golden">
                        <nav aria-label="breadcrumb">
                            <ul>
                                <li><a asp-controller="Home" asp-action="Index">Trang Chủ</a></li>
                                <li class="active" aria-current="page">Yêu Thích</li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> <!-- ...:::: End Breadcrumb Section:::... -->
<!-- ...:::: Start Wishlist Section:::... -->
<div class="wishlist-section">
    <!-- Start Cart Table -->
    <div class="wishlish-table-wrapper" data-aos="fade-up" data-aos-delay="0">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table_desc">
                        <div class="table_page table-responsive">
                            <table>
                                <!-- Start Wishlist Table Head -->
                                <thead>
                                    <tr>
                                        <th class="product_thumb">Hình ảnh</th>
                                        <th class="product_name">Sản phẩm</th>
                                        <th class="product-price">Giá</th>
                                        <th class="product_addcart"></th>
                                        <th class="product_remove"></th>
                                    </tr>
                                </thead>
                                <!-- End Cart Table Head -->
                                <tbody>
                                    @if (Model == null || !Model.Any())
                                    {
                                        <tr>
                                            <td colspan="5" class="text-center">Không có sản phẩm nào trong danh sách yêu thích.</td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var item in Model)
                                        {
                                            <tr>
                                                <td class="product_thumb">
                                                    <a asp-controller="Product" asp-action="ProductDetail" asp-route-slug="@item.Slug">
                                                        <img src="@Url.Content("~/images/" + (item.Image ?? "default-image.jpg"))" alt="@item.Name" onerror="this.src='/images/default-image.jpg';" />
                                                    </a>
                                                </td>
                                                <td class="product_name">
                                                    <a asp-controller="Product" asp-action="ProductDetail" asp-route-slug="@item.Slug">
                                                        @item.Name
                                                    </a>
                                                </td>
                                                <td class="product-price">@String.Format(new CultureInfo("vi-VN"), "{0:C}", item.Price)</td>
                                                <td class="product_addcart">
                                                    <a href="#" class="btn btn-md btn-golden add-to-cart" data-slug="@item.Slug">
                                                        Thêm vào giỏ
                                                    </a>
                                                </td>
                                                <td class="product_remove">
                                                    <a href="#" class="remove-from-wishlist" data-id="@item.ProductId"><i class="fa fa-trash-o"></i></a>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End Cart Table -->
</div> <!-- ...:::: End Wishlist Section:::... -->
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.remove-from-wishlist').click(function (e) {
                e.preventDefault();
                var $this = $(this);
                var productId = $this.data('id');

                $.ajax({
                    url: '@Url.Action("RemoveFavorite", "Account")',
                    type: 'GET',
                    data: { productId: productId },
                    success: function (response) {
                        if (response.success) {
                            $this.closest('tr').remove();
                            alert(response.message);
                            if ($('.wishlist-section tbody tr').length === 0) {
                                $('.wishlist-section tbody').html('<tr><td colspan="5" class="text-center">Không có sản phẩm nào trong danh sách yêu thích.</td></tr>');
                            }
                        } else {
                            alert(response.message || 'Đã xảy ra lỗi khi xóa.');
                        }
                    },
                    error: function () {
                        alert('Đã xảy ra lỗi khi xóa khỏi danh sách yêu thích.');
                    }
                });
            });

            $('.add-to-cart').click(function (e) {
                e.preventDefault();
                var $this = $(this);
                var slug = $this.data('slug');
                var quantity = 1;

                $.ajax({
                    url: '@Url.Action("AddToCart", "Cart")',
                    type: 'POST',
                    data: { slug: slug, quantity: quantity },
                    success: function (result) {
                        if (result.success) {
                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "#5cb85c",
                                className: "info"
                            }).showToast();
                        } else {
                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "#FF0000",
                                className: "error"
                            }).showToast();
                        }
                    },
                    error: function () {
                        Toastify({
                            text: 'Có lỗi xảy ra khi thêm sản phẩm vào giỏ hàng.',
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "#FF0000",
                            className: "error"
                        }).showToast();
                    }
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
}